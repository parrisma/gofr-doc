services:
  # 1. MCP Server (Core Logic)
  mcp:
    image: gofr-doc_prod:latest
    container_name: gofr-doc-mcp
    restart: unless-stopped
    command: python -m app.main_mcp --no-auth --host 0.0.0.0 --port 8010
    environment:
      - GOFR_DOC_ENV=PROD
      - GOFR_DOC_LOG_LEVEL=INFO
      # Web URL for proxy mode - use container hostname
      - GOFR_DOC_WEB_URL=http://gofr-doc-web:8012
      # For production with auth, uncomment and set:
      # - GOFR_DOC_JWT_SECRET=your-secret-key-here
    ports:
      - "8010:8010"
    volumes:
      - gofr_doc_data:/home/gofr-doc/data
    networks:
      - gofr-net

  # 2. MCPO Server (OpenAPI Wrapper)
  mcpo:
    image: gofr-doc_prod:latest
    container_name: gofr-doc-mcpo
    restart: unless-stopped
    depends_on:
      - mcp
    command: python -m app.main_mcpo --mcp-host gofr-doc-mcp --mcp-port 8010 --mcpo-host 0.0.0.0 --mcpo-port 8011
    environment:
      - GOFR_DOC_ENV=PROD
    ports:
      - "8011:8011"
    volumes:
      - gofr_doc_data:/home/gofr-doc/data
    networks:
      - gofr-net

  # 3. Web Server (Frontend/API)
  web:
    image: gofr-doc_prod:latest
    container_name: gofr-doc-web
    restart: unless-stopped
    command: python -m app.main_web --no-auth --host 0.0.0.0 --port 8012
    environment:
      - GOFR_DOC_ENV=PROD
      # For production with auth, uncomment and set:
      # - GOFR_DOC_JWT_SECRET=your-secret-key-here
    ports:
      - "8012:8012"
    volumes:
      - gofr_doc_data:/home/gofr-doc/data
    networks:
      - gofr-net

  # 4. Backup Service (Sidecar using gofr-common shared backup)
  backup:
    image: gofr-common-backup:latest
    container_name: gofr-doc-backup
    restart: unless-stopped
    depends_on:
      - mcp
      - web
    environment:
      # Project identifier (required)
      - GOFR_PROJECT=doc
      
      # Backup scheduling
      - GOFR_DOC_BACKUP_ENABLED=${GOFR_DOC_BACKUP_ENABLED:-true}
      - GOFR_DOC_BACKUP_SCHEDULE=${GOFR_DOC_BACKUP_SCHEDULE:-0 2 * * *}
      
      # Retention policies
      - GOFR_DOC_BACKUP_RETENTION_DAYS=${GOFR_DOC_BACKUP_RETENTION_DAYS:-30}
      - GOFR_DOC_BACKUP_MAX_COUNT=${GOFR_DOC_BACKUP_MAX_COUNT:-90}
      
      # What to backup (paths relative to /data)
      - GOFR_DOC_BACKUP_PATHS=${GOFR_DOC_BACKUP_PATHS:-storage:storage,auth:auth,logs:../logs}
      
      # Compression
      - GOFR_DOC_BACKUP_COMPRESSION=${GOFR_DOC_BACKUP_COMPRESSION:-gzip}
      - GOFR_DOC_BACKUP_COMPRESSION_LEVEL=${GOFR_DOC_BACKUP_COMPRESSION_LEVEL:-6}
      
      # Housekeeping
      - GOFR_DOC_BACKUP_CLEANUP_ON_START=${GOFR_DOC_BACKUP_CLEANUP_ON_START:-true}
      - GOFR_DOC_BACKUP_VERIFY_AFTER_BACKUP=${GOFR_DOC_BACKUP_VERIFY_AFTER_BACKUP:-true}
      
      # Tiered retention (optional)
      - GOFR_DOC_BACKUP_ENABLE_WEEKLY=${GOFR_DOC_BACKUP_ENABLE_WEEKLY:-false}
      - GOFR_DOC_BACKUP_ENABLE_MONTHLY=${GOFR_DOC_BACKUP_ENABLE_MONTHLY:-false}
      - GOFR_DOC_BACKUP_WEEKLY_RETENTION_WEEKS=${GOFR_DOC_BACKUP_WEEKLY_RETENTION_WEEKS:-8}
      - GOFR_DOC_BACKUP_MONTHLY_RETENTION_MONTHS=${GOFR_DOC_BACKUP_MONTHLY_RETENTION_MONTHS:-12}
    volumes:
      - gofr_doc_data:/data:ro              # Read-only access to app data
      - gofr_doc_backups:/backups:rw        # Write access to backups
    networks:
      - gofr-net

# Shared Volume for Persistence
volumes:
  gofr_doc_data:
    name: gofr-doc_data
    external: false # Set to true if you created it manually via CLI
  
  gofr_doc_backups:
    name: gofr-doc_backups
    external: false

# Shared Network
networks:
  gofr-net:
    name: gofr-net
    external: true # Assumes network exists (created by other gofr services)
