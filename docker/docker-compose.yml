# =============================================================================
# gofr-doc Production Stack (Docker Compose)
# =============================================================================
# Mirrors gofr-dig compose pattern:
# - One container per service (MCP, MCPO, Web)
# - Vault auth uses AppRole creds injected via shared secrets volume
# - Shared gofr-net network
#
# Requirements:
# - Vault container running on gofr-net as hostname: gofr-vault (port 8201)
# - Shared secrets volume seeded: gofr-secrets (contains service_creds/gofr-doc.json)
# - JWT signing secret stored in Vault at secret/gofr/config/jwt-signing-secret
#   (provisioned by manage_vault.sh bootstrap during platform bootstrap)
# =============================================================================

services:
  # ==========================================================================
  # 1. MCP Server (Streamable HTTP)
  # ==========================================================================
  mcp:
    image: gofr-doc-prod:latest
    container_name: gofr-doc-mcp
    hostname: gofr-doc-mcp
    restart: unless-stopped
    user: root
    working_dir: /home/gofr-doc
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -e
        mkdir -p /run/secrets /home/gofr-doc/data/storage /home/gofr-doc/data/sessions /home/gofr-doc/logs
        cp /run/gofr-secrets/service_creds/gofr-doc.json /run/secrets/vault_creds
        chown gofr-doc:gofr-doc /run/secrets/vault_creds
        chmod 600 /run/secrets/vault_creds
        chown -R gofr-doc:gofr-doc /home/gofr-doc/data /home/gofr-doc/logs
        # Read JWT signing secret from Vault via AppRole
        GOFR_JWT_SECRET=$(/home/gofr-doc/.venv/bin/python -c "
        import json, os, sys
        sys.path.insert(0, '/home/gofr-doc')
        from gofr_common.auth.backends.vault_config import VaultConfig
        from gofr_common.auth.backends.vault_client import VaultClient
        creds = json.load(open('/run/secrets/vault_creds'))
        config = VaultConfig(url=os.environ.get('GOFR_DOC_VAULT_URL','http://gofr-vault:8201'), role_id=creds['role_id'], secret_id=creds['secret_id'])
        client = VaultClient(config)
        print(client.read_secret('gofr/config/jwt-signing-secret')['value'])
        ")
        export GOFR_JWT_SECRET
        exec su -s /bin/bash gofr-doc -c '/home/gofr-doc/.venv/bin/python -m app.main_mcp --host 0.0.0.0 --port ${GOFR_DOC_MCP_PORT:-8040} --jwt-secret ${GOFR_JWT_SECRET} --templates-dir /home/gofr-doc/data/templates --styles-dir /home/gofr-doc/data/styles --web-url http://gofr-doc-web:${GOFR_DOC_WEB_PORT:-8042} --proxy-url-mode url'
    environment:
      - GOFR_DOC_ENV=PROD
      - GOFR_DOC_LOG_LEVEL=INFO
      - GOFR_DOC_AUTH_BACKEND=vault
      - GOFR_DOC_VAULT_URL=http://gofr-vault:8201
      - GOFR_DOC_VAULT_PATH_PREFIX=gofr/doc/auth
      - GOFR_DOC_VAULT_MOUNT=secret
      - GOFR_DOC_WEB_URL=http://gofr-doc-web:${GOFR_DOC_WEB_PORT:-8042}
    ports:
      - "${GOFR_DOC_MCP_PORT:-8040}:8040"
    volumes:
      - gofr-doc-data:/home/gofr-doc/data
      - gofr-doc-logs:/home/gofr-doc/logs
      - gofr-secrets:/run/gofr-secrets:ro
    networks:
      - gofr-net

  # ==========================================================================
  # 2. MCPO Server (OpenAPI Wrapper)
  # ==========================================================================
  mcpo:
    image: gofr-doc-prod:latest
    container_name: gofr-doc-mcpo
    hostname: gofr-doc-mcpo
    restart: unless-stopped
    user: gofr-doc
    working_dir: /home/gofr-doc
    entrypoint: []
    depends_on:
      - mcp
    command: >
      /home/gofr-doc/.venv/bin/mcpo
      --host 0.0.0.0 --port ${GOFR_DOC_MCPO_PORT:-8041} --server-type streamable-http
      -- http://gofr-doc-mcp:${GOFR_DOC_MCP_PORT:-8040}/mcp
    environment:
      - GOFR_DOC_ENV=PROD
    ports:
      - "${GOFR_DOC_MCPO_PORT:-8041}:8041"
    networks:
      - gofr-net

  # ==========================================================================
  # 3. Web Server (REST API)
  # ==========================================================================
  web:
    image: gofr-doc-prod:latest
    container_name: gofr-doc-web
    hostname: gofr-doc-web
    restart: unless-stopped
    user: root
    working_dir: /home/gofr-doc
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        set -e
        mkdir -p /run/secrets /home/gofr-doc/data/storage /home/gofr-doc/data/sessions /home/gofr-doc/logs
        cp /run/gofr-secrets/service_creds/gofr-doc.json /run/secrets/vault_creds
        chown gofr-doc:gofr-doc /run/secrets/vault_creds
        chmod 600 /run/secrets/vault_creds
        chown -R gofr-doc:gofr-doc /home/gofr-doc/data /home/gofr-doc/logs
        # Read JWT signing secret from Vault via AppRole
        GOFR_JWT_SECRET=$(/home/gofr-doc/.venv/bin/python -c "
        import json, os, sys
        sys.path.insert(0, '/home/gofr-doc')
        from gofr_common.auth.backends.vault_config import VaultConfig
        from gofr_common.auth.backends.vault_client import VaultClient
        creds = json.load(open('/run/secrets/vault_creds'))
        config = VaultConfig(url=os.environ.get('GOFR_DOC_VAULT_URL','http://gofr-vault:8201'), role_id=creds['role_id'], secret_id=creds['secret_id'])
        client = VaultClient(config)
        print(client.read_secret('gofr/config/jwt-signing-secret')['value'])
        ")
        export GOFR_JWT_SECRET
        exec su -s /bin/bash gofr-doc -c '/home/gofr-doc/.venv/bin/python -m app.main_web --host 0.0.0.0 --port ${GOFR_DOC_WEB_PORT:-8042} --jwt-secret ${GOFR_JWT_SECRET} --templates-dir /home/gofr-doc/data/templates --fragments-dir /home/gofr-doc/data/fragments --styles-dir /home/gofr-doc/data/styles'
    environment:
      - GOFR_DOC_ENV=PROD
      - GOFR_DOC_LOG_LEVEL=INFO
      - GOFR_DOC_AUTH_BACKEND=vault
      - GOFR_DOC_VAULT_URL=http://gofr-vault:8201
      - GOFR_DOC_VAULT_PATH_PREFIX=gofr/doc/auth
      - GOFR_DOC_VAULT_MOUNT=secret
    ports:
      - "${GOFR_DOC_WEB_PORT:-8042}:8042"
    volumes:
      - gofr-doc-data:/home/gofr-doc/data
      - gofr-doc-logs:/home/gofr-doc/logs
      - gofr-secrets:/run/gofr-secrets:ro
    networks:
      - gofr-net

# Shared volumes
volumes:
  gofr-doc-data:
    name: gofr-doc-data
    external: true
  gofr-doc-logs:
    name: gofr-doc-logs
    external: true
  gofr-secrets:
    name: gofr-secrets
    external: true

# Shared network
networks:
  gofr-net:
    name: gofr-net
    external: true
