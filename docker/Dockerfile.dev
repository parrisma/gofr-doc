FROM gofr-doc-base:latest

# Install Git, GitHub CLI, SSH daemon, and network/debug utilities
RUN apt-get update && apt-get install -y \
    git \
    gh \
    openssh-server \
    # Network utilities
    iputils-ping \
    dnsutils \
    net-tools \
    netcat-openbsd \
    curl \
    wget \
    telnet \
    # Process/port utilities
    lsof \
    htop \
    strace \
    tcpdump \
    # Text processing
    jq \
    vim \
    && rm -rf /var/lib/apt/lists/*

# Set default UID and GID (can be overridden at build time)
ARG USER_UID=1000
ARG USER_GID=1000

# Add Unix group 'gofr-doc' with configurable GID
RUN groupadd --system --gid ${USER_GID} gofr-doc

# Add user 'gofr-doc' with configurable UID and assign to group 'gofr-doc'
RUN useradd --system --uid ${USER_UID} --gid ${USER_GID} --home-dir /home/gofr-doc --create-home gofr-doc

# Create project directory and data directory, set ownership to gofr-doc
RUN mkdir -p /home/gofr-doc/devroot/gofr-doc /home/gofr-doc/devroot/gofr-doc/data && \
    chown -R gofr-doc:gofr-doc /home/gofr-doc/devroot

# Copy entrypoint script as root before switching users
COPY docker/entrypoint-dev.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Switch to gofr-doc user
USER gofr-doc
WORKDIR /home/gofr-doc/devroot/gofr-doc

# Configure SSH for user gofr-doc only (no exposed port, uses ~/.ssh)
RUN mkdir -p /home/gofr-doc/.ssh && chmod 700 /home/gofr-doc/.ssh

# Create a UV virtual environment for development in the project directory
RUN uv venv /home/gofr-doc/devroot/gofr-doc/.venv --python=python3.11

# Set environment variables to use the project venv
ENV VIRTUAL_ENV=/home/gofr-doc/devroot/gofr-doc/.venv
ENV PATH="/home/gofr-doc/devroot/gofr-doc/.venv/bin:$PATH"

# Use entrypoint to handle initialization
ENTRYPOINT ["/entrypoint.sh"]

# Keep container running with infinite wait loop
CMD ["tail", "-f", "/dev/null"]
