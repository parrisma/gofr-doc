{# Table fragment template - CSS-driven styling #}
{# Styling is controlled by .doco-table classes in style.css #}
{# Use 'compact' parameter for tighter spacing #}

{# Set default values #}
{% set compact = compact|default(false) %}
{% set column_alignments = column_alignments|default(none) %}
{% set number_format = number_format|default(none) %}
{% set highlight_rows = highlight_rows|default(none) %}
{% set highlight_columns = highlight_columns|default(none) %}
{% set sort_by = sort_by|default(none) %}
{% set column_widths = column_widths|default(none) %}
{% set has_header = has_header|default(true) %}

{# Apply sorting if sort_by is specified (sorts on raw values before formatting) #}
{% if sort_by %}
  {% set rows = rows|sort_table(sort_by, has_header) %}
{% endif %}

{# Title #}
{% if title %}
<div class="table-title">{{ title }}</div>
{% endif %}

<table class="doco-table{% if compact %} compact{% endif %}"{% if width and width != 'auto' %} style="width: {% if width == 'full' %}100%{% else %}{{ width }}{% endif %};"{% endif %}>
  {# Column widths (if specified) #}
  {% if column_widths %}
  <colgroup>
    {% set num_columns = rows[0]|length if rows|length > 0 else 0 %}
    {% for col_index in range(num_columns) %}
    <col{% if (col_index|string) in column_widths %} style="width: {{ column_widths[col_index|string] }};"{% endif %}>
    {% endfor %}
  </colgroup>
  {% endif %}
  
  {# Header row #}
  {% if has_header and rows|length > 0 %}
  <thead>
    <tr>
      {% for cell in rows[0] %}
      {% set col_index = loop.index0 %}
      {% set alignment = column_alignments[col_index] if column_alignments and col_index < column_alignments|length else none %}
      <th{% if alignment %} style="text-align: {{ alignment }};"{% endif %}>
        {{ cell }}
      </th>
      {% endfor %}
    </tr>
  </thead>
  {% endif %}
  
  {# Data rows #}
  <tbody>
    {% set start_index = 1 if has_header else 0 %}
    {% for row in rows[start_index:] %}
    {% set row_index = loop.index0 %}
    {% set actual_row_index = row_index + start_index %}
    {% set row_class = [] %}
    {% if highlight_rows and (actual_row_index|string) in highlight_rows %}
      {% set _ = row_class.append('highlight') %}
    {% endif %}
    <tr{% if row_class %} class="{{ row_class|join(' ') }}"{% endif %}>
      {% for cell in row %}
      {% set col_index = loop.index0 %}
      {% set alignment = column_alignments[col_index] if column_alignments and col_index < column_alignments|length else none %}
      {% set format_spec = number_format.get(col_index|string) if number_format else none %}
      {% set formatted_cell = cell|format_number(format_spec) if format_spec else cell %}
      {% set td_class = [] %}
      {% if highlight_columns and (col_index|string) in highlight_columns %}
        {% set _ = td_class.append('highlight-column') %}
      {% endif %}
      <td{% if td_class %} class="{{ td_class|join(' ') }}"{% endif %}{% if alignment %} style="text-align: {{ alignment }};"{% endif %}>
        {{ formatted_cell }}
      </td>
      {% endfor %}
    </tr>
    {% endfor %}
  </tbody>
</table>
