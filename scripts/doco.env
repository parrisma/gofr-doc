#!/bin/bash
# Centralized Doco Configuration
# Source this file in all scripts and tests:
#   source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/doco.env"
#
# Environment Modes:
#   DOCO_ENV=PROD  => uses $DOCO_ROOT/data
#   DOCO_ENV=TEST  => uses $DOCO_ROOT/test/data (default)

# Determine DOCO_ROOT - the project root directory
if [ -z "${DOCO_ROOT:-}" ]; then
    # Try to get from BASH_SOURCE first (when directly sourced)
    if [ -n "${BASH_SOURCE[0]:-}" ] 2>/dev/null; then
        DOCO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
    elif [ -n "${PROJECT_ROOT:-}" ]; then
        # Use PROJECT_ROOT if set by caller (run_tests.sh sets this)
        DOCO_ROOT="${PROJECT_ROOT}"
    else
        # Fallback to current directory
        DOCO_ROOT="$(cd "." && pwd)"
    fi
fi

# Set environment mode (PROD or TEST)
export DOCO_ENV="${DOCO_ENV:-TEST}"

# Core directories
export DOCO_ROOT
export DOCO_LOGS="${DOCO_ROOT}/logs"

# Select data directory based on environment
if [ "$DOCO_ENV" = "PROD" ]; then
    export DOCO_DATA="${DOCO_ROOT}/data"
else
    export DOCO_DATA="${DOCO_ROOT}/test/data"
fi

# Data subdirectories (based on DOCO_ENV)
export DOCO_TEMPLATES="${DOCO_DATA}/docs/templates"
export DOCO_FRAGMENTS="${DOCO_DATA}/docs/fragments"
export DOCO_STYLES="${DOCO_DATA}/docs/styles"
export DOCO_STORAGE="${DOCO_DATA}/storage"

# Token store (always in logs directory)
export DOCO_TOKEN_STORE="${DOCO_LOGS}/doco_tokens.json"

# Create required directories if they don't exist
mkdir -p "$DOCO_LOGS"
mkdir -p "$DOCO_TEMPLATES"
mkdir -p "$DOCO_FRAGMENTS"
mkdir -p "$DOCO_STYLES"
mkdir -p "$DOCO_STORAGE"

# Server defaults
export DOCO_MCP_PORT=${DOCO_MCP_PORT:-8010}
export DOCO_MCPO_PORT=${DOCO_MCPO_PORT:-8011}
export DOCO_WEB_PORT=${DOCO_WEB_PORT:-8012}
