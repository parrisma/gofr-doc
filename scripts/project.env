#!/bin/bash
# Centralized gofr-doc configuration.
# Canonical location for sourced env defaults.
#
# NOTE: This file is designed to be sourced.

# Determine GOFR_DOC_ROOT - the project root directory
if [ -z "${GOFR_DOC_ROOT:-}" ]; then
    if [ -n "${BASH_SOURCE[0]:-}" ] 2>/dev/null; then
        GOFR_DOC_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
    elif [ -n "${PROJECT_ROOT:-}" ]; then
        GOFR_DOC_ROOT="${PROJECT_ROOT}"
    else
        GOFR_DOC_ROOT="$(cd "." && pwd)"
    fi
fi
export GOFR_DOC_ROOT

# Set environment mode (PROD or TEST)
export GOFR_DOC_ENV="${GOFR_DOC_ENV:-TEST}"

# Load centralized port config if present (single source of truth)
_PORTS_ENV="${GOFR_DOC_ROOT}/lib/gofr-common/config/gofr_ports.env"
if [ -f "${_PORTS_ENV}" ]; then
    # shellcheck source=/dev/null
    source "${_PORTS_ENV}"
fi
unset _PORTS_ENV

# Core directories
export GOFR_DOC_LOGS="${GOFR_DOC_LOGS:-${GOFR_DOC_ROOT}/logs}"

# Select data directory based on environment
if [ "$GOFR_DOC_ENV" = "PROD" ]; then
    export GOFR_DOC_DATA="${GOFR_DOC_DATA:-${GOFR_DOC_ROOT}/data}"
else
    export GOFR_DOC_DATA="${GOFR_DOC_DATA:-${GOFR_DOC_ROOT}/test/data}"
fi

# Data subdirectories
export GOFR_DOC_TEMPLATES="${GOFR_DOC_TEMPLATES:-${GOFR_DOC_DATA}/docs/templates}"
export GOFR_DOC_FRAGMENTS="${GOFR_DOC_FRAGMENTS:-${GOFR_DOC_DATA}/docs/fragments}"
export GOFR_DOC_STYLES="${GOFR_DOC_STYLES:-${GOFR_DOC_DATA}/docs/styles}"
export GOFR_DOC_STORAGE="${GOFR_DOC_STORAGE:-${GOFR_DOC_DATA}/storage}"

# Token store (always in logs directory)
export GOFR_DOC_TOKEN_STORE="${GOFR_DOC_TOKEN_STORE:-${GOFR_DOC_LOGS}/gofr-doc_tokens.json}"

# Create required directories if they don't exist
mkdir -p "$GOFR_DOC_LOGS" 2>/dev/null || true
mkdir -p "$GOFR_DOC_TEMPLATES" 2>/dev/null || true
mkdir -p "$GOFR_DOC_FRAGMENTS" 2>/dev/null || true
mkdir -p "$GOFR_DOC_STYLES" 2>/dev/null || true
mkdir -p "$GOFR_DOC_STORAGE" 2>/dev/null || true

# Server defaults
export GOFR_DOC_HOST="${GOFR_DOC_HOST:-0.0.0.0}"
export GOFR_DOC_MCP_PORT="${GOFR_DOC_MCP_PORT:-8040}"
export GOFR_DOC_MCP_HOST="${GOFR_DOC_MCP_HOST:-$GOFR_DOC_HOST}"
export GOFR_DOC_MCPO_PORT="${GOFR_DOC_MCPO_PORT:-8041}"
export GOFR_DOC_MCPO_HOST="${GOFR_DOC_MCPO_HOST:-$GOFR_DOC_HOST}"
export GOFR_DOC_WEB_PORT="${GOFR_DOC_WEB_PORT:-8042}"
export GOFR_DOC_WEB_HOST="${GOFR_DOC_WEB_HOST:-$GOFR_DOC_HOST}"

# Docker network configuration
if [ "$GOFR_DOC_ENV" = "PROD" ]; then
    export GOFR_DOC_NETWORK="${GOFR_DOC_NETWORK:-gofr-net}"
else
    export GOFR_DOC_NETWORK="${GOFR_DOC_NETWORK:-gofr-test-net}"
fi
